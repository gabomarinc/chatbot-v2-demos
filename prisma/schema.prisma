generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String            @id @default(cuid())
  name         String?
  email        String            @unique
  passwordHash String
  image        String?
  lastLoginAt  DateTime?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  role         AppRole           @default(USER)
  workspaces   Workspace[]
  memberships  WorkspaceMember[]
  assignedConversations Conversation[]
}

model GlobalConfig {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Workspace {
  id            String            @id @default(cuid())
  name          String
  createdAt     DateTime          @default(now())
  ownerId       String
  agents        Agent[]
  costTracking  CostTracking[]
  creditBalance CreditBalance?
  payments      Payment[]
  subscription  Subscription?
  usageLogs     UsageLog[]
  owner         User              @relation(fields: [ownerId], references: [id])
  members       WorkspaceMember[]
  contacts      Contact[]         // Added relation
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  userId      String
  workspaceId String
  role        WorkspaceRole
  user        User          @relation(fields: [userId], references: [id])
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

model Agent {
  id                 String             @id @default(cuid())
  workspaceId        String
  name               String
  avatarUrl          String?
  communicationStyle CommunicationStyle
  personalityPrompt  String
  jobType            AgentJobType
  jobCompany         String?
  jobWebsiteUrl      String?
  jobDescription     String?
  model              String
  temperature        Float              @default(0.3)
  timezone           String             @default("UTC")
  allowEmojis        Boolean            @default(false)
  signMessages       Boolean            @default(true)
  restrictTopics     Boolean            @default(false)
  splitLongMessages  Boolean            @default(true)
  allowReminders     Boolean            @default(false)
  smartRetrieval     Boolean            @default(false)
  transferToHuman    Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  workspace          Workspace          @relation(fields: [workspaceId], references: [id])
  integrations       AgentIntegration[]
  mcpServers         AgentMCPServer[]
  channels           Channel[]
  conversations      Conversation[]
  intents            Intent[]
  knowledgeBases     KnowledgeBase[]
  media              AgentMedia[]
  customFieldDefinitions CustomFieldDefinition[] // Added relation
}

model KnowledgeBase {
  id      String            @id @default(cuid())
  agentId String
  name    String
  agent   Agent             @relation(fields: [agentId], references: [id])
  sources KnowledgeSource[]
}

model KnowledgeSource {
  id              String              @id @default(cuid())
  knowledgeBaseId String
  type            KnowledgeSourceType
  url             String?
  fileUrl         String?
  status          KnowledgeStatus
  updateInterval  UpdateInterval      @default(NEVER)
  crawlSubpages   Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  chunks          DocumentChunk[]
  knowledgeBase   KnowledgeBase       @relation(fields: [knowledgeBaseId], references: [id])
}

model DocumentChunk {
  id                String          @id @default(cuid())
  knowledgeSourceId String
  content           String
  embedding         Json
  createdAt         DateTime        @default(now())
  knowledgeSource   KnowledgeSource @relation(fields: [knowledgeSourceId], references: [id])
}

model Channel {
  id            String         @id @default(cuid())
  agentId       String
  type          ChannelType
  displayName   String
  configJson    Json
  isActive      Boolean        @default(false)
  agent         Agent          @relation(fields: [agentId], references: [id])
  conversations Conversation[]
}

model Conversation {
  id            String             @id @default(cuid())
  agentId       String
  channelId     String?
  contactId     String?            // New relation to Contact
  externalId    String
  contactName   String?
  contactEmail  String?
  status        ConversationStatus @default(OPEN)
  lastMessageAt DateTime?
  assignedTo    String?            // User ID who is assigned to this conversation
  assignedAt    DateTime?          // When the conversation was assigned
  createdAt     DateTime           @default(now())
  agent         Agent              @relation(fields: [agentId], references: [id])
  channel       Channel?           @relation(fields: [channelId], references: [id])
  contact       Contact?           @relation(fields: [contactId], references: [id]) 
  assignedUser  User?              @relation(fields: [assignedTo], references: [id])
  messages      Message[]
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           MessageRole
  content        String
  metadata       Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
}

model Intent {
  id             String    @id @default(cuid())
  agentId        String
  name           String
  description    String?
  trigger        String    // Regex pattern or keywords
  enabled        Boolean   @default(true)
  
  // Action configuration
  actionType     String    @default("WEBHOOK") // "WEBHOOK", "INTERNAL", "FORM"
  actionUrl      String?   // For webhooks
  payloadJson    Json?     // Action-specific config
  
  // Analytics
  triggerCount   Int       @default(0)
  lastTriggered  DateTime?
  
  agent          Agent     @relation(fields: [agentId], references: [id])
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt
}

model AgentIntegration {
  id         String              @id @default(cuid())
  agentId    String
  provider   IntegrationProvider
  configJson Json
  enabled    Boolean             @default(false)
  agent      Agent               @relation(fields: [agentId], references: [id])
}

model AgentMCPServer {
  id       String  @id @default(cuid())
  agentId  String
  name     String
  endpoint String
  apiKey   String?
  agent    Agent   @relation(fields: [agentId], references: [id])
}

model AgentMedia {
  id          String   @id @default(cuid())
  agentId     String
  url         String   // URL de la imagen en R2
  fileName    String   // Nombre original del archivo
  description String?  // Descripción de la imagen para búsqueda
  tags        String[] // Tags para categorizar (ej: ["casa", "exterior", "sala"])
  altText     String?  // Texto alternativo para accesibilidad
  prompt      String?  // Instrucciones específicas para el chatbot (ej: "Cuando el usuario pida imagen de la casa A, envía esta")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([tags])
}

enum CustomFieldType {
  TEXT
  NUMBER
  BOOLEAN
  DATE
  SELECT
}

model Contact {
  id            String   @id @default(cuid())
  workspaceId   String
  name          String?
  email         String?
  phone         String?
  externalId    String?  // ID in external system (e.g. CRM, WhatsApp JID)
  
  // Dynamic Data
  customData    Json?    // { "salary": 2000, "city": "Panama" }
  tags          String[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
  conversations Conversation[]

  @@index([workspaceId])
  @@index([email])
  @@index([phone])
  @@index([customData], type: Gin) // High performance filtering for JSONB
}

model CustomFieldDefinition {
  id          String          @id @default(cuid())
  agentId     String
  key         String          // Machine friendly key: "monthly_salary"
  label       String          // Human label: "Salario Mensual"
  type        CustomFieldType
  description String?         // Description for AI: "The user's monthly income"
  options     String[]        // For SELECT type
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  agent       Agent           @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, key])
  @@index([agentId])
}

model SubscriptionPlan {
  id              String         @id @default(cuid())
  name            String
  type            PlanType
  monthlyPrice    Float
  creditsPerMonth Int
  maxAgents       Int
  maxMembers      Int            @default(1)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  subscriptions   Subscription[]
}

model Subscription {
  id                   String           @id @default(cuid())
  workspaceId          String           @unique
  planId               String
  status               String           @default("active")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  currentPeriodStart   DateTime         @default(now())
  currentPeriodEnd     DateTime
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  payments             Payment[]
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  workspace            Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

model Payment {
  id              String        @id @default(cuid())
  subscriptionId  String?
  workspaceId     String
  amount          Float
  currency        String        @default("USD")
  type            String
  status          String
  stripePaymentId String?
  creditsAdded    Int?
  createdAt       DateTime      @default(now())
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id])
  workspace       Workspace     @relation(fields: [workspaceId], references: [id])
}

model CostTracking {
  id            String    @id @default(cuid())
  workspaceId   String
  model         String
  creditsUsed   Int
  estimatedCost Float
  date          DateTime  @default(now())
  workspace     Workspace @relation(fields: [workspaceId], references: [id])
}

model CreditBalance {
  id          String    @id @default(cuid())
  workspaceId String    @unique
  balance     Int       @default(0)
  totalUsed   Int       @default(0)
  lastResetAt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
}

model UsageLog {
  id             String    @id @default(cuid())
  workspaceId    String
  agentId        String?
  conversationId String?
  tokensUsed     Int
  creditsUsed    Int
  model          String
  createdAt      DateTime  @default(now())
  channelId      String?
  workspace      Workspace @relation(fields: [workspaceId], references: [id])
}

enum AppRole {
  USER
  SUPER_ADMIN
}

enum WorkspaceRole {
  OWNER
  MANAGER
  AGENT
}

enum CommunicationStyle {
  FORMAL
  NORMAL
  CASUAL
}

enum AgentJobType {
  SUPPORT
  SALES
  PERSONAL
}

enum KnowledgeSourceType {
  TEXT
  WEBSITE
  VIDEO
  DOCUMENT
}

enum KnowledgeStatus {
  PENDING
  PROCESSING
  READY
  FAILED
}

enum UpdateInterval {
  NEVER
  DAILY
  WEEKLY
  MONTHLY
}

enum ChannelType {
  WHATSAPP
  INSTAGRAM
  MESSENGER
  WEBCHAT
}

enum ConversationStatus {
  OPEN
  PENDING
  CLOSED
}

enum MessageRole {
  USER
  AGENT
  HUMAN
}

enum IntegrationProvider {
  ELEVENLABS
  GOOGLE_CALENDAR
  PLUGCHAT
  EVENDI
}

enum PlanType {
  FRESHIE
  MONEY_HONEY
  WOLF_OF_WALLSTREET
  CUSTOM
}
